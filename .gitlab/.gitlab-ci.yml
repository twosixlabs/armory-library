default:
  image: "python:3.8-slim-bullseye"
  tags:
    - twosix

stages:
  - "ğŸ“¡ Code Linting"
  - "ğŸš§ Static Analysis"
  - "ğŸ§ª Unit Tests"
  - "ğŸ“– Generate Docs"
  - "ğŸ”¨ Build"
  # - "ğŸš€ Deploy"  # TODO: Add deploy stage for Advana target; e.g. package, container, etc. -CW

variables:
  LC_ALL: "C.UTF-8"
  LANG: "C.UTF-8"
  DEBIAN_FRONTEND: noninteractive
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/pip"
  PYTHON_VENV_DIR: "$CI_PROJECT_DIR/venv"
  ARMORY_CI_TEST: 1
  PYTEST_PARAMS: >-
    --exitfirst
    --suppress-no-test-exit-code

cache: &global_cache
  key: shared-job-key
  policy: pull-push
  untracked: true
  paths:
    - $PIP_CACHE_DIR

before_script:
  - apt-get update -qqy
  - apt-get install -qqy --no-install-recommends --no-install-suggests git libgl1-mesa-glx gnupg build-essential rsync make software-properties-common
  - python -m pip install --upgrade pip build wheel
  # Set up authenticated access for JATIC gitlab repositories
  - echo -e "machine gitlab.jatic.net\nlogin gitlab-ci-token\npassword ${CI_JOB_TOKEN}" > ~/.netrc
  - git config --global url."https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.jatic.net".insteadof "ssh://git@gitlab.jatic.net"
  - git config --global url."https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.jatic.net/".insteadOf "git@gitlab.jatic.net:"

code-linting:
  stage: "ğŸ“¡ Code Linting"
  only:
    - merge_requests
  script:
    - pip install pre-commit
    - make lint

static_analysis:
  stage: "ğŸš§ Static Analysis"
  artifacts:
    paths:
      - bandit_scan.txt
    expire_in: 6 hours
    when: on_success
  allow_failure: true
  dependencies:
    - code-linting
  only:
    - merge_requests
  script:
    - pip install bandit mypy
    - make scan

unit-test:
  stage: "ğŸ§ª Unit Tests"
  dependencies:
    - code-linting
  only:
    - jatic
    - merge_requests
  script:
    - make install
    - make test

examples-test:
  stage: "ğŸ§ª Unit Tests"
  dependencies:
    - code-linting
  only:
    - jatic
    - merge_requests
  script:
    - cd examples
    - make install
    - make test

pages:
  stage: "ğŸ“– Generate Docs"
  artifacts:
    paths:
      - public
  dependencies:
    - code-linting
    - unit-test
  only:
    - jatic
    - merge_requests
  script:
    - pip install mkdocs mkdocstrings mkdocs-exclude mkdocs-material
    - make docs

build:
  stage: "ğŸ”¨ Build"
  artifacts:
    paths:
      - dist/*.whl
  dependencies:
    - code-linting
    - examples-test
    - unit-test
  only:
    - jatic
    - merge_requests
  script:
    - make install
    - make build
    # TODO: Add build for Advana target; e.g. package, container, etc. -CW
    # - make docker
