---
name: CI Tests

on:
  push:
    branches:
      - master
      - develop

  pull_request:
    branches:
      - master
      - develop

  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1

jobs:
  host-test:
    name: Basic `native` configuration
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: ['ubuntu-20.04', 'macos-latest']
        python-version: ['3.9']
      fail-fast: false
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v1
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install Armory
        shell: bash
        run: |
          pip install --no-compile --editable '.[developer]'
          pip install --no-compile --editable '.[host]'
          pip install --no-compile --editable .
          armory configure --use-defaults
      - name: Run armory host tests
        shell: bash
        run: |
          pytest -s ./tests/unit/test_configuration.py
  native-simple:
    name: Native Mode test_no_docker.py
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: ['ubuntu-20.04', 'macos-latest']
        python-version: ['3.9']
      fail-fast: false
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v1
        with:
          python-version: ${{ matrix.python-version }}
      - name: Run armory host tests
        shell: bash
        run: |
          pip install --no-compile --editable '.[developer]'
          pip install --no-compile --editable '.[host]'
          pip install --no-compile --editable .
          armory configure --use-defaults
          pytest -s ./tests/end_to_end/test_no_docker.py
  native-all-unit:
    name: Native Mode All unit tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: ['ubuntu-20.04', 'macos-latest']
        python-version: ['3.9']
      fail-fast: false
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v1
        with:
          python-version: ${{ matrix.python-version }}
      - name: Run armory host tests
        shell: bash
        run: |
          pip install --no-compile --editable '.[developer]'
          pip install --no-compile --editable '.[host]'
          pip install --no-compile --editable .
          armory configure --use-defaults
          pytest -m "not docker_required and unit" ./tests/
  docker-torch-unit:
    name: Docker Pytorch Unit Tests
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v1
        with:
          python-version: '3.9'
      - name: Build Docker
        run: |
          pip install --no-compile --editable '.[developer]'
          pip install --no-compile --editable '.[host]'
          pip install --no-compile --editable .
          python docker/build.py pytorch
      - name: Run Unit tests
        run: |
          docker run -w /armory-repo/ twosixarmory/pytorch:$(armory --version) pytest -m "not docker_required and unit" ./tests/
  docker-tf2-unit:
    name: Docker TF2 Unit Tests
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v1
        with:
          python-version: '3.9'
      - name: Build Docker
        run: |
          pip install --no-compile --editable '.[developer]'
          pip install --no-compile --editable '.[host]'
          pip install --no-compile --editable .
          python docker/build.py tf2
      - name: Run Unit tests
        run: |
          docker run -w /armory-repo/ twosixarmory/tf2:$(armory --version) pytest -m "not docker_required and unit" ./tests/
  docker-deepspeech-unit:
    name: Docker Deepspeech Unit Tests
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v1
        with:
          python-version: '3.9'
      - name: Build Docker
        run: |
          pip install --no-compile --editable '.[developer]'
          pip install --no-compile --editable '.[host]'
          pip install --no-compile --editable .
          python docker/build.py pytorch-deepspeech
      - name: Run Unit tests
        run: |
          docker run -w /armory-repo/ twosixarmory/pytorch-deepspeech:$(armory --version) \
          pytest -m "not docker_required and unit" ./tests/
          docker run -w /armory-repo/ twosixarmory/pytorch-deepspeech:$(armory --version) \
          pytest -m "pytorch_deepspeech" ./tests/
  formatting-test:
    name: Check Code Formatting
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v1
        with:
          python-version: '3.9'
      - name: install test requirements
        run: |
          pip install --no-compile --editable '.[developer]'
          pip install --no-compile --editable '.[host]'
          pip install --no-compile --editable .
      - name: Run commit hooks
        run: bash tools/pre-commit.sh
