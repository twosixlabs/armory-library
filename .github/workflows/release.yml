---
name: 🎁 Armory Release Workflow

on:
    workflow_dispatch:

    push:
        tags:
          - 'v[0-9]+.[0-9]+.[0-9]+'
jobs:
  release-wheel:
    name: 📦 Publish release wheels to PyPI
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Checkout Armory with full depth (for tags and SCM)
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.event.client_payload.branch }}

      - name: Install
        run: |
          pip install pip>=23
          pip install hatch

      - name: Build wheels
        run: |
          cd library && hatch build --clean --target wheel
          cd examples && hatch build --clean --target wheel

      - name: Upload wheels to PyPI
        run: |
           cd library && hatch publish --user __token__ --auth ${{ secrets.PYPI_PUBLISH_TOKEN }}
           cd examples && hatch publish --user __token__ --auth ${{ secrets.PYPI_PUBLISH_TOKEN }}
