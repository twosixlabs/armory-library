---
name: 🎁 Armory Release Workflow

on:
  repository_dispatch:
    types: build-and-release

  workflow_dispatch:
    inputs:
      test:
        type: boolean
        description: publish to pypi test server
        required: true
        default: true

jobs:
  release-wheel:
    name: 🛞 Build release wheel
    runs-on: ubuntu-latest
    steps:
      - name: 🐍 Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: 3.10

      - name: 📩 Checkout Armory with full depth (for tags and SCM)
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.event.client_payload.branch }}

      - name: 🔨 Build wheel
        run: |
          pip install pip>=23
          pip install hatch
          hatch build --clean --target wheel

      - name: 📦 Upload wheel to PyPI
        run: |
           hatch publish --user __token__ --auth ${{ secrets.PYPI_PUBLISH_TOKEN }}
