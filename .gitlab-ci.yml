image: "ubuntu:latest"

before_script:
  - apt-get update -qy
  - apt-get install -y git python3 python3-pip
  - mkdir -p /tmp/artifacts
  - python3 --version
  - python3 -m pip install --upgrade pip
  - python3 -m pip install --upgrade build
  - pip3 install --no-compile --editable '.[developer]'
  - armory configure --use-defaults

stages:
  - Code Linting
  - Static Analysis
  - Unit Tests
  - Build
  # - Deploy  # TODO: Add deploy stage for Advana target; e.g. package, container, etc. -CW

code_linting:
  stage: Code Linting
  only:
    - merge_requests
  script:
    - bash tools/pre-commit.sh

static_analysis:
  stage: Static Analysis
  only:
    - merge_requests
  script:
    - bandit -v -f txt -r ./armory -c "pyproject.toml" --output /tmp/artifacts/bandit_scan.txt || $( exit 0 ); echo $?

unit_test:
  stage: Unit Tests
  only:
    - merge_requests
  script:
    - python3 -m build --sdist --wheel --outdir dist/ .
    # - pytest -c pyproject.toml -s ./tests/unit/test_configuration.py
    # - PYTEST_PARAMS="--exitfirst --suppress-no-test-exit-code"; pytest -c pyproject.toml -m "not docker_required and unit" ./tests/
    # - PYTEST_PARAMS=" --exitfirst --suppress-no-test-exit-code"; pytest -c pyproject.toml -s ./tests/end_to_end/test_no_docker.py

build:
  stage: Build
  only:
    - merge_requests
  script:
    - python3 -m build --sdist --wheel --outdir dist/ .


#########################################
## DEVELOPER NOTES
#########################################
# o TODO: Collect artifacts - https://docs.gitlab.com/ee/ci/yaml/#artifacts
